---
apiVersion: v1
kind: ConfigMap
metadata:
  name: network-exporter-script
  namespace: nexslice
data:
  network_exporter.py: |
    #!/usr/bin/env python3
    """Simple network traffic exporter for Prometheus."""
    import time
    from prometheus_client import start_http_server, Gauge
    
    rx_bytes = Gauge('gnb_network_receive_bytes_total', 'Total bytes received', ['interface'])
    tx_bytes = Gauge('gnb_network_transmit_bytes_total', 'Total bytes transmitted', ['interface'])
    rx_packets = Gauge('gnb_network_receive_packets_total', 'Total packets received', ['interface'])
    tx_packets = Gauge('gnb_network_transmit_packets_total', 'Total packets transmitted', ['interface'])
    
    def read_net_dev():
        stats = {}
        with open('/proc/net/dev', 'r') as f:
            lines = f.readlines()[2:]
            for line in lines:
                parts = line.split(':')
                if len(parts) != 2:
                    continue
                iface = parts[0].strip()
                values = parts[1].split()
                if len(values) >= 16:
                    stats[iface] = {
                        'rx_bytes': int(values[0]),
                        'rx_packets': int(values[1]),
                        'tx_bytes': int(values[8]),
                        'tx_packets': int(values[9])
                    }
        return stats
    
    def update_metrics():
        stats = read_net_dev()
        for iface, values in stats.items():
            if iface == 'eth0':
                rx_bytes.labels(interface=iface).set(values['rx_bytes'])
                tx_bytes.labels(interface=iface).set(values['tx_bytes'])
                rx_packets.labels(interface=iface).set(values['rx_packets'])
                tx_packets.labels(interface=iface).set(values['tx_packets'])
    
    if __name__ == '__main__':
        start_http_server(8000)
        print("Network exporter started on :8000/metrics")
        while True:
            try:
                update_metrics()
            except Exception as e:
                print(f"Error: {e}")
            time.sleep(5)

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ueransim-gnb-config
  namespace: nexslice
data:
  gnb.yaml: |
    mcc: '208'
    mnc: '95'
    nci: '0x000000010'
    idLength: 32
    tac: 1
    
    linkIp: 0.0.0.0
    ngapIp: 0.0.0.0
    gtpIp: 0.0.0.0
    
    # List of AMF address information
    amfConfigs:
      - address: oai-amf
        port: 38412
    
    # List of supported S-NSSAIs by this gNB
    slices:
      - sst: 1
    
    # Indicates whether or not SCTP stream number errors should be ignored.
    ignoreStreamIds: true

---
apiVersion: v1
kind: Pod
metadata:
  name: ueransim-gnb
  namespace: nexslice
  labels:
    app: ueransim-gnb
spec:
  containers:
  - name: ueransim-gnb
    image: gradiant/ueransim:3.2.6
    imagePullPolicy: Always
    args: ["gnb", "/etc/ueransim/gnb.yaml"]
    env:
    - name: AMF_HOSTNAME
      value: "oai-amf"
    volumeMounts:
    - name: config-volume
      mountPath: /etc/ueransim
    securityContext:
      capabilities:
        add: ["NET_ADMIN"]
      privileged: false
  - name: network-exporter
    image: python:3.11-alpine
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e
        echo "Installing prometheus_client..."
        pip install --no-cache-dir prometheus_client
        echo "Starting network exporter..."
        python3 /app/network_exporter.py
    volumeMounts:
    - name: exporter-script
      mountPath: /app
    ports:
    - containerPort: 8000
      name: metrics
      protocol: TCP
  volumes:
  - name: config-volume
    configMap:
      name: ueransim-gnb-config
  - name: exporter-script
    configMap:
      name: network-exporter-script
      defaultMode: 0755
  restartPolicy: Always

---
apiVersion: v1
kind: Service
metadata:
  name: ueransim-gnb
  namespace: nexslice
spec:
  selector:
    app: ueransim-gnb
  clusterIP: None  # Headless service for pod-to-pod radio link simulation
  ports:
  - name: ngap
    port: 38412
    protocol: TCP
  - name: gtp
    port: 2152
    protocol: UDP
  - name: metrics
    port: 8000
    protocol: TCP
